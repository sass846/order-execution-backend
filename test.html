<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Order Execution Test</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
        }

        .box {
            border: 1px solid #444;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
        }

        button {
            background: #000;
            color: #fff;
            border: none;
            padding: 10px 20px;
            font-weight: bold;
            cursor: pointer;
        }

        button:hover {
            background: #0c0;
        }

        input {
            background: #333;
            border: 1px solid #555;
            color: #fff;
            padding: 5px;
            margin-bottom: 10px;
            width: 100px;
        }

        label {
            display: inline-block;
            width: 100px;
        }

        #logs {
            white-space: pre-wrap;
            margin-top: 10px;
        }
    </style>
</head>

<body>
    <h1>Order Execution Test</h1>
    <div class="box">
        <p>1. Make sure Worker is running (`npm run worker`)</p>
        <p>2. Configure Order:</p>

        <div>
            <label>Input Token:</label>
            <input type="text" id="inputToken" value="SOL">
        </div>
        <div>
            <label>Output Token:</label>
            <input type="text" id="outputToken" value="USDC">
        </div>
        <div>
            <label>Amount:</label>
            <input type="number" id="amount" value="100">
        </div>
        <br>
        <button onclick="startTest()">SIMULATE ORDER</button>
    </div>
    <div class="box">
        <h3>Logs</h3>
        <div id="logs">Waiting...</div>
    </div>

    <script>
        const logDiv = document.getElementById('logs');
        const appendLog = (msg) => {
            const time = new Date().toLocaleTimeString();
            logDiv.innerHTML += `<div>[${time}] ${msg}</div>`;
        };

        async function startTest() {
            const inputToken = document.getElementById('inputToken').value;
            const outputToken = document.getElementById('outputToken').value;
            const amount = parseFloat(document.getElementById('amount').value);

            if (!inputToken || !outputToken || !amount) {
                alert('Please fill all fields');
                return;
            }

            logDiv.innerHTML = 'Starting...<br>';

            // Connect WS
            const ws = new WebSocket('ws://' + location.host + '/ws');

            ws.onopen = async () => {
                appendLog('--> WebSocket Connected');

                // 2. Submit Order
                try {
                    appendLog(`--> Submitting Order ${amount} ${inputToken} -> ${outputToken}...`);
                    const res = await fetch('/api/orders/execute', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            inputToken,
                            outputToken,
                            amount
                        })
                    });
                    const d = await res.json();
                    appendLog(`--> Order Created: ${d.orderId} (${d.status})`);

                    // 3. Subscribe
                    appendLog(`--> Subscribing to updates...`);
                    ws.send(JSON.stringify({ type: 'subscribe', orderId: d.orderId }));

                } catch (e) {
                    appendLog('x Error: ' + e.message);
                }
            };

            ws.onmessage = (e) => {
                const msg = JSON.parse(e.data);

                let details = '';
                if (msg.price) details += ` ($${msg.price.toFixed(2)})`;
                if (msg.executedPrice) details += ` (Exec: $${msg.executedPrice.toFixed(2)})`;
                if (msg.dex) details += ` [${msg.dex}]`;
                if (msg.txHash) details += ` (TX: ${msg.txHash})`;
                if (msg.error) details += ` (Error: ${msg.error})`;

                appendLog(`--> UPDATE: [${msg.status.toUpperCase()}] ${details}`);

                if (msg.status === 'confirmed' || msg.status === 'failed') {
                    appendLog('Order Complete!');
                    ws.close();
                }
            };
        }
    </script>
</body>

</html>